# 穴通過状態管理分離計画

## 概要

現在、`PlayerCube`クラスで穴通過状態（`isInHole`など）を管理していますが、`CubeCamera`と`HolePreview`で異なる判定ロジックが必要なため、別クラスに分離します。

## 問題点

### 現在の実装
- `PlayerCube`クラスで穴通過状態を一元管理
- `CubeCamera`と`HolePreview`で同じ状態を参照
- しかし、判定ロジックが異なる：
  - **CubeCamera**: カメラが穴から1マス以上出たら`isInHole`解除
  - **HolePreview**: キューブが穴から1マス以上出たら`isInHole`解除

### 問題
1つの変数で2つの異なる参照座標（カメラとキューブ）を管理できない

## 解決策

穴通過状態管理を別クラスに分離し、`CubeCamera`と`HolePreview`でそれぞれ独立したインスタンスを持つ。

## 設計

### クラス構成

```
HoleState (単一クラス)
```

### クラス仕様

#### HoleState
```java
public class HoleState {
    // 状態管理
    private boolean isInHole = false;
    private boolean prevIsInHole = false;
    private Location lastHoleLocation = null;
    private static final double HOLE_PASS_MARGIN = 1.0;
    
    // 状態取得メソッド
    public boolean isInHole() { return isInHole; }
    public Location getLastHoleLocation() { return lastHoleLocation; }
    public boolean hasHoleStateChanged() { return isInHole != prevIsInHole; }
    
    // 穴通過状態を更新
    public void updateHoleStatus(Location holeLocation, double targetZ) {
        prevIsInHole = isInHole;
        
        if (holeLocation != null) {
            if (!isInHole) {
                isInHole = true;
            }
            lastHoleLocation = holeLocation.clone();
        } else {
            if (isInHole && lastHoleLocation != null && 
                targetZ > lastHoleLocation.getZ() + HOLE_PASS_MARGIN) {
                isInHole = false;
                lastHoleLocation = null;
            }
        }
    }
}
```

## 移行計画

### 1. 新クラス作成
- `HoleState.java` (単一クラス)

### 2. PlayerCubeクラス修正
- 穴通過状態管理メソッドを削除
- `updateHoleStatusForCamera()` メソッドを削除

### 3. CubeCameraクラス修正
- `HoleState`のインスタンスを追加
- `update()`メソッドで新しい状態管理を使用（カメラのZ座標を渡す）

### 4. HolePreviewクラス修正
- `HoleState`のインスタンスを追加
- `update()`メソッドで新しい状態管理を使用（キューブのZ座標を渡す）

### 5. 依存関係の整理
- `CubeCamera`と`HolePreview`で独立した状態管理
- `PlayerCube`は純粋にキューブの物理状態のみ管理

## メリット

1. **責任分離**: 各クラスが自分の責任に集中
2. **独立性**: `CubeCamera`と`HolePreview`が独立したインスタンスで動作
3. **簡素化**: 単一クラスで管理がシンプル
4. **保守性**: バグ修正や機能追加が局所化される

## 注意事項

- `PlayerCube.detectHole()`メソッドは保持（共通の穴検出ロジック）
- 既存のAPIとの互換性を保つ
- テスト時に両方の状態管理が正しく動作することを確認
