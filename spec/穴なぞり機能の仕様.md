# 穴なぞり機能の仕様

## 概要

プレイヤーキューブが壁の穴を通過する際に、穴の形状を「なぞる」ことを検出し、適切な効果音とエフェクトを再生する機能。

## 基本概念

### 用語定義

- **壁**: 5x5範囲でブロックが10個以上ある障害物（Z座標が固定）
- **穴**: 壁の中の空気ブロック（AIR, CAVE_AIR, VOID_AIR）
- **キューブ**: プレイヤーが操作する3x3x3のブロック形状（回転可能）
- **投影**: キューブの3D形状を壁のZ座標に投影した2D形状
- **なぞる**: キューブの投影が穴の位置と重なること

### 壁の検出

1. キューブの前方1～100ブロック先を探索
2. 5x5範囲でブロックが10個以上ある位置を壁として検出
3. 壁の中の空気ブロックを「穴」として記録

## なぞり判定の仕様

### 前提条件

なぞり判定は以下の条件を**すべて満たす**場合のみ実行される：

1. **緑プレビュー状態**: キューブ全体が穴を通過できる状態（`canPassThrough == true`）
2. **穴通過中でない**: 穴の中に入っていない状態（`!holeState.isInHole()`）
3. **未完了の壁**: その壁がまだ完了していない（`!completedWalls.contains(wallZ)`）

### なぞり判定のロジック

#### 1. 初回なぞり判定（部分的）

キューブの投影が穴と重なった時：

```
例: 4x1の穴 [A, B, C, D] があり、3x1のキューブが存在

状態1: キューブが [A, B, C] に重なる
  → A, B, C を「なぞった穴」として記録
  → 各穴で初めてなぞった瞬間に HOLE_TRACE 音を再生
  → パーティクルエフェクトを表示
```

#### 2. 完全なぞり判定

すべての穴をなぞった時：

```
状態2: キューブが右に移動して [B, C, D] に重なる
  → D を新たに「なぞった穴」として記録
  → D の HOLE_TRACE 音を再生
  → なぞった穴 = [A, B, C, D] = 全穴
  → HOLE_COMPLETE 音を再生
```

**完了条件:**
```java
currentlyTracedHoles.size() == allHoles.size()
&& allHoles.containsAll(currentlyTracedHoles)
```

- なぞった穴の数 = 全穴の数
- なぞった穴がすべて有効な穴（全穴に含まれる）

## 効果音とエフェクト

### HOLE_TRACE（部分的になぞった音）

- **タイミング**: 穴を初めてなぞった瞬間（個別の穴ごと）
- **音**: パリンという音
- **エフェクト**:
  - パーティクル: `HAPPY_VILLAGER`（3個）
  - パーティクル: `END_ROD`（2個）

### HOLE_COMPLETE（完了音）

- **タイミング**: すべての穴をなぞり終えた瞬間（壁ごとに1回のみ）
- **音**: 完了音
- **条件**: 完了判定が初めて成立した時のみ（`!completedWalls.contains(wallZ)`）

## 状態管理

### なぞり状態のリセット

以下の場合、なぞり状態がリセットされる：

1. **白→緑の変化**: 通れない状態から通れる状態に変わった時
   - 失敗後の再挑戦を可能にするため

2. **穴から出た時**: 穴の中から外に出た時
   - 穴通過後の再挑戦を可能にするため

### 完了状態の保持

- 完了した壁は `completedWalls` に記録される
- キューブが壁を通過してマージン（1.0ブロック）を超えるまで保持
- マージンを超えた後、データがクリアされる

## 現在の問題

### 問題1: キューブの投影が穴以外の座標を含む

**症状:**
```
全穴: [-7,-53,121, -7,-52,121, -7,-54,121]  (3個)
なぞった穴: [-7,-53,121, -8,-54,121, -7,-52,121, -7,-54,121, -9,-53,121, ...]  (10個)
```
