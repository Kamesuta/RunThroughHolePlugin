# パッケージリファクタリング計画書（修正版）

## 概要
現在の単一パッケージ構成を**player**と**game**の2つのパッケージに分離し、**Main**と**RunHoleCommand**はトップレベルに残す実用的な構造にする。

## 現状の問題
- 全クラスが`mods.kpw.runthroughhole`パッケージに混在
- 機能別の分離ができていない
- 依存関係が不明確

## 提案する新しいパッケージ構成（修正版）

### トップレベル（mods.kpw.runthroughhole）
**責任**: プラグインのエントリーポイント・コマンド処理

**含まれるクラス**:
- `Main.java` - プラグインのエントリーポイント
- `RunHoleCommand.java` - コマンドハンドラー

### 1. player パッケージ
**責任**: プレイヤー関連の機能・データ管理・イベント処理

**含まれるクラス**:
- `PlayerData.java` - プレイヤーデータの定義
- `PlayerDataManager.java` - プレイヤーデータの管理
- `PlayerGameListener.java` - プレイヤーのゲームイベント処理

**パッケージ名**: `mods.kpw.runthroughhole.player`

### 2. game パッケージ
**責任**: ゲーム固有のロジック・オブジェクト

**含まれるクラス**:
- `GameManager.java` - ゲームロジックの管理
- `PlayerCube.java` - プレイヤーのキューブ
- `CubeCamera.java` - カメラシステム
- `HolePreview.java` - 穴のプレビュー表示
- `CubeBlock.java` - キューブのブロック
- `HoleState.java` - 穴の状態管理

**パッケージ名**: `mods.kpw.runthroughhole.game`

## 実装手順

### Phase 1: パッケージディレクトリの作成
1. `src/main/java/mods/kpw/runthroughhole/player/` を作成
2. `src/main/java/mods/kpw/runthroughhole/game/` を作成

### Phase 2: ファイルの移動
1. **トップレベルに残す**:
   - `Main.java` - そのまま（package宣言は変更なし）
   - `RunHoleCommand.java` - そのまま（package宣言は変更なし）

2. **player パッケージへ移動**:
   - `PlayerData.java` → `player/PlayerData.java`
   - `PlayerDataManager.java` → `player/PlayerDataManager.java`
   - `PlayerGameListener.java` → `player/PlayerGameListener.java`

3. **game パッケージへ移動**:
   - `GameManager.java` → `game/GameManager.java`
   - `PlayerCube.java` → `game/PlayerCube.java`
   - `CubeCamera.java` → `game/CubeCamera.java`
   - `HolePreview.java` → `game/HolePreview.java`
   - `CubeBlock.java` → `game/CubeBlock.java`
   - `HoleState.java` → `game/HoleState.java`

### Phase 3: package宣言の更新
移動したファイルのpackage宣言を新しいパッケージ名に更新

### Phase 4: import文の修正
1. 内部クラス間のimport文を更新
2. 外部ライブラリのimport文はそのまま維持
3. 依存関係に基づいてimport文を整理

### Phase 5: ビルドテスト
1. コンパイルエラーの確認
2. リンターエラーの修正
3. ビルド成功の確認

## 期待される効果

### 実用的な構造
- エントリーポイントとコマンドはトップレベルで見つけやすい
- 機能別にファイルが整理される
- 過度な分割を避けて適度な粒度

### 明確な責任分離
- **トップレベル**: プラグインの入り口
- **player**: プレイヤー中心の機能
- **game**: ゲームロジック中心の機能

### 保守性の向上
- 機能別にファイルが整理される
- バグの原因特定が容易

## 依存関係図

```
Main (トップレベル)
├── player.PlayerDataManager
├── player.PlayerGameListener
└── game.GameManager

RunHoleCommand (トップレベル)
└── Main

player.PlayerDataManager
└── player.PlayerData

player.PlayerGameListener
├── Main
├── player.PlayerData
└── game.PlayerCube

game.GameManager
├── player.PlayerDataManager
├── game.PlayerCube
├── game.CubeCamera
└── game.HolePreview

game.PlayerCube
├── game.CubeBlock
└── game.HoleState

game.CubeCamera
└── game.PlayerCube

game.HolePreview
└── game.PlayerCube
```

## ファイル構成（実装後）

```
src/main/java/mods/kpw/runthroughhole/
├── Main.java                   # プラグインエントリーポイント（72行）
├── RunHoleCommand.java         # コマンドハンドラー
│
├── player/                     # プレイヤー関連
│   ├── PlayerData.java         # プレイヤーデータ（43行）
│   ├── PlayerDataManager.java  # プレイヤーデータ管理（92行）
│   └── PlayerGameListener.java # ゲームイベントリスナー（373行）
│
└── game/                      # ゲーム関連
    ├── GameManager.java        # ゲームロジック管理（306行）
    ├── PlayerCube.java         # プレイヤーキューブ（506行）
    ├── CubeCamera.java         # カメラシステム（237行）
    ├── HolePreview.java        # 穴プレビュー（311行）
    ├── CubeBlock.java          # キューブブロック（17行）
    └── HoleState.java          # 穴状態
```

## パッケージ分離の利点

### トップレベル
- **プラグインのエントリーポイント**: Mainクラスがすぐに見つかる
- **コマンド処理**: RunHoleCommandがすぐに見つかる
- **外部インターフェース**: プラグインの主要な入り口

### player パッケージ
- **プレイヤー中心の機能**: データ管理、イベント処理
- **プラグイン固有**: このプラグイン専用のプレイヤー機能

### game パッケージ
- **ゲームロジック**: キューブ、カメラ、プレビューなどのゲーム要素
- **内部実装**: プレイヤーからは抽象化されたゲーム機能
- **再利用可能**: 他のゲームモードでも使用可能な設計

## 注意事項
- 段階的な実装でリスクを最小化
- 各段階でビルド・テストを実行
- 既存のAPIは維持（後方互換性）
- 依存関係の循環参照を避ける

## 実装完了後の確認項目
- [ ] 全パッケージのimport文が正しく設定されている
- [ ] 依存関係に循環参照がない
- [ ] ビルドが成功する
- [ ] 既存の機能が正常に動作する
- [ ] コードスタイルが統一されている

## 比較：各構成の特徴

| 項目 | 4パッケージ版 | 2パッケージ版 | **修正版（推奨）** |
|------|---------------|---------------|-------------------|
| 複雑さ | 高い | 低い | **低い** |
| 理解しやすさ | 中程度 | 高い | **高い** |
| 実装コスト | 高い | 低い | **低い** |
| 実用性 | 高い | 中程度 | **高い** |
| メンテナンス性 | 高い | 中程度 | **高い** |

**推奨**: 修正版が最も実用的で、エントリーポイントが見つけやすく、適度な分離効果が得られる。
